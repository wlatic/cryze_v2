# Full stack deployment: Cryze (GW cameras) + Wyze Bridge (non-GW) + Frigate NVR
#
# All services get LAN IPs via macvlan for direct camera access.
# Configuration: copy .env.example to .env and set your values.
#
# Usage:
#   docker compose -f docker-compose.frigate.yml up -d --build
#
# Stream sources:
#   GW cameras (OG, Doorbell Pro) → Cryze → rtsp://CONTAINER_IP:8554/live/<name>
#   Non-GW cameras (V3, Pan, etc) → Wyze Bridge → rtsp://WYZE_BRIDGE_IP:8554/<name>
#   All cameras → Frigate for recording/detection

networks:
  lan:
    driver: macvlan
    driver_opts:
      parent: ${LAN_INTERFACE:-ens18}
    ipam:
      config:
        - subnet: ${LAN_SUBNET:-10.10.0.0/16}
          gateway: ${LAN_GATEWAY:-10.10.0.1}
          ip_range: ${LAN_IP_RANGE:-10.10.20.208/29}

services:
  # =========================================
  # Frigate NVR — recording + AI detection
  # =========================================
  frigate:
    image: ghcr.io/blakeblackshear/frigate:stable
    container_name: frigate
    restart: unless-stopped
    networks:
      lan:
        ipv4_address: ${FRIGATE_IP:-10.10.20.210}
    volumes:
      - ./frigate/config:/config
      - ./frigate/storage:/media/frigate
      - type: tmpfs
        target: /tmp/cache
        tmpfs:
          size: 1000000000 # 1GB tmpfs for cache
    environment:
      FRIGATE_RTSP_PASSWORD: ""
    # Uncomment if using Coral USB accelerator:
    # devices:
    #   - /dev/bus/usb:/dev/bus/usb
    # Uncomment if using Intel GPU for hardware acceleration:
    # devices:
    #   - /dev/dri/renderD128:/dev/dri/renderD128
    privileged: true

  # =========================================
  # docker-wyze-bridge — non-GW Wyze cameras
  # (V3, V2, Pan, Outdoor, Floodlight, etc)
  # =========================================
  wyze-bridge:
    image: mrlt8/wyze-bridge:latest
    container_name: wyze-bridge
    restart: unless-stopped
    networks:
      lan:
        ipv4_address: ${WYZE_BRIDGE_IP:-10.10.20.211}
    environment:
      WYZE_EMAIL: ${WYZE_EMAIL}
      WYZE_PASSWORD: ${WYZE_PASSWORD}
      API_ID: ${WYZE_KEY_ID}
      API_KEY: ${WYZE_API_KEY}
      # Quality: 1=SD, 2=HD (default), 3=Auto
      QUALITY: ${WYZE_BRIDGE_QUALITY:-2}
      WB_AUTH: "false"
      # Only bridge non-GW cameras (GW cameras go through Cryze)
      # Set FILTER_NAMES or FILTER_MODELS in .env to control which cameras
      # Example: FILTER_MODELS=WYZEC1-JZ,WYZECP1_JEF (exclude GW models)
    volumes:
      - ./wyze-bridge:/config

  # =========================================
  # Cryze — GW-based Wyze cameras
  # (OG, Doorbell Pro, etc)
  # =========================================
  mediamtx:
    image: bluenviron/mediamtx:latest-ffmpeg
    network_mode: service:cryze_android_app
    privileged: true
    environment:
      MTX_WEBRTCADDITIONALHOSTS: ${CONTAINER_IP:-10.10.20.215}
      MTX_API: "yes"

  cryze_android_app:
    restart: unless-stopped
    depends_on:
      cryze_api:
        condition: service_healthy
    networks:
      lan:
        ipv4_address: ${CONTAINER_IP:-10.10.20.215}
    build:
      context: ./cryze_android_app
      dockerfile: Dockerfile
      args:
        CRYZE_RTSP_SERVER: "localhost"
        CRYZE_BACKEND_URL: "http://${API_IP:-10.10.20.216}:8080"
    privileged: true
    command:
      - androidboot.use_memfd=1
      - androidboot.redroid_net_ndns=2
      - androidboot.redroid_net_dns1=${LAN_GATEWAY:-10.10.0.1}
      - androidboot.redroid_net_dns2=8.8.8.8
      - androidboot.redroid_gpu_mode=guest
      - androidboot.zygote=zygote64
      - ro.config.low_ram=true
      - dalvik.vm.heapsize=256m
      - dalvik.vm.heapgrowthlimit=128m

  cryze_api:
    restart: unless-stopped
    volumes:
      - ./data:/app/data
    networks:
      lan:
        ipv4_address: ${API_IP:-10.10.20.216}
    build:
      context: ./cryze_api_python
      dockerfile: Dockerfile
    env_file:
      - .env
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 60s
