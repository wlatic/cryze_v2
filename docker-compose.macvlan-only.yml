# Macvlan-only deployment for direct LAN camera streaming
#
# Configuration:
#   Copy .env.example to .env and set your network values.
#   All network settings are in .env â€” no need to edit this file.
#
# Usage:
#   docker compose -f docker-compose.macvlan-only.yml up -d --build

networks:
  lan:
    driver: macvlan
    driver_opts:
      parent: ${LAN_INTERFACE:-ens18}
    ipam:
      config:
        - subnet: ${LAN_SUBNET:-10.10.0.0/16}
          gateway: ${LAN_GATEWAY:-10.10.0.1}
          ip_range: ${LAN_IP_RANGE:-10.10.20.208/29}

services:
  mediamtx:
    image: bluenviron/mediamtx:latest-ffmpeg
    network_mode: service:cryze_android_app
    privileged: true
    environment:
      MTX_WEBRTCADDITIONALHOSTS: ${CONTAINER_IP:-10.10.20.215}
      MTX_API: "yes"
  cryze_android_app:
    restart: unless-stopped
    depends_on:
      cryze_api:
        condition: service_healthy
    networks:
      lan:
        ipv4_address: ${CONTAINER_IP:-10.10.20.215}
    build:
      context: ./cryze_android_app
      dockerfile: Dockerfile
      args:
        CRYZE_RTSP_SERVER: "localhost"
        CRYZE_BACKEND_URL: "http://${API_IP:-10.10.20.216}:8080"
    privileged: true
    command:
      - androidboot.use_memfd=1
      - androidboot.redroid_net_ndns=2
      - androidboot.redroid_net_dns1=${LAN_GATEWAY:-10.10.0.1}
      - androidboot.redroid_net_dns2=8.8.8.8
      - androidboot.redroid_gpu_mode=guest
      # Memory optimizations
      - androidboot.zygote=zygote64 # 64-bit only, skip 32-bit runtime (~197MB saved)
      - ro.config.low_ram=true # Reduce system allocations
      - dalvik.vm.heapsize=256m # Cap Dalvik heap
      - dalvik.vm.heapgrowthlimit=128m # Limit per-app heap growth
  cryze_api:
    restart: unless-stopped
    volumes:
      - ./data:/app/data
    networks:
      lan:
        ipv4_address: ${API_IP:-10.10.20.216}
    build:
      context: ./cryze_api_python
      dockerfile: Dockerfile
    env_file:
      - .env
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 60s
